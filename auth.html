<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kazi Mashinani - Rural Job Opportunities</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Your existing CSS styles remain exactly the same */
        /* ... [All your existing CSS] ... */
    </style>
</head>
<body>
    <!-- Your existing HTML structure remains exactly the same -->
    <!-- ... [All your existing HTML] ... -->

    <script>
        const API_BASE_URL = 'https://backita.onrender.com';
        let currentUser = null;
        let currentJobs = [];
        let currentEmployees = [];
        let currentLanguage = 'en';
        let userJobs = [];
        let currentEditingJobId = null;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });

        async function checkAuthentication() {
            try {
                // First try to check session via backend
                const response = await fetch(`${API_BASE_URL}/auth/check`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user) {
                        currentUser = data.user;
                        initializeApp();
                        return;
                    }
                }
            } catch (error) {
                console.log('Backend auth check failed, trying fallback:', error);
            }
            
            // Fallback: Check sessionStorage for temporary user data
            try {
                const tempUserData = sessionStorage.getItem('tempUserData');
                if (tempUserData) {
                    const userData = JSON.parse(tempUserData);
                    const loginTime = userData.loginTime;
                    const currentTime = new Date().getTime();
                    const hoursSinceLogin = (currentTime - loginTime) / (1000 * 60 * 60);
                    
                    // If login was less than 24 hours ago, use the data
                    if (hoursSinceLogin < 24) {
                        currentUser = userData.user;
                        // Ensure role is set from login data
                        if (userData.role) {
                            currentUser.role = userData.role;
                        }
                        initializeApp();
                        return;
                    } else {
                        // Clear expired session
                        sessionStorage.removeItem('tempUserData');
                    }
                }
            } catch (error) {
                console.error('Error with fallback authentication:', error);
                sessionStorage.removeItem('tempUserData');
            }
            
            // If no authentication method worked, redirect to login
            window.location.href = 'auth.html';
        }

        function initializeApp() {
            // Update UI with user info
            document.getElementById('userName').textContent = currentUser.name;
            
            // Update role badge
            const roleBadge = document.getElementById('userRoleBadge');
            if (currentUser.role === 'employer') {
                roleBadge.textContent = currentLanguage === 'en' ? 'Employer' : 'Mwajiri';
                roleBadge.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)';
            } else {
                roleBadge.textContent = currentLanguage === 'en' ? 'Employee' : 'Mfanyakazi';
                roleBadge.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            }
            
            // Update welcome message
            document.getElementById('welcomeMessage').textContent = currentLanguage === 'en' 
                ? `Welcome ${currentUser.name}!` 
                : `Karibu ${currentUser.name}!`;
            
            // Show role-specific content
            updateRoleBasedUI();
            
            // Set language from user preference or default to English
            const savedLanguage = localStorage.getItem('preferredLanguage');
            if (savedLanguage) {
                currentLanguage = savedLanguage;
            }
            updateLanguageDisplay();
            translatePage();
            
            // Load initial data
            loadBlogs();
            loadJobs();
            
            // Setup event listeners
            const jobForm = document.getElementById('jobForm');
            if (jobForm) {
                jobForm.addEventListener('submit', handleJobPost);
            }
        }

        // Update UI based on user role
        function updateRoleBasedUI() {
            const isEmployer = currentUser.role === 'employer';
            const isEmployee = currentUser.role === 'employee';
            
            // Show/hide navigation items
            document.getElementById('postJobNav').classList.toggle('hidden', !isEmployer);
            document.getElementById('employeesNav').classList.toggle('hidden', !isEmployer);
            document.getElementById('myApplicationsNav').classList.toggle('hidden', !isEmployee);
            
            // Show/hide welcome sections
            document.getElementById('employerWelcome').classList.toggle('hidden', !isEmployer);
            document.getElementById('employeeWelcome').classList.toggle('hidden', !isEmployee);
            
            // Update welcome section styling
            const welcomeSection = document.getElementById('welcomeSection');
            if (isEmployer) {
                welcomeSection.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)';
            } else {
                welcomeSection.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            }
        }

        // Rest of your existing JavaScript functions remain the same
        // ... [All your existing JavaScript functions] ...

        async function logout() {
            try {
                // Try backend logout
                await fetch(`${API_BASE_URL}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Backend logout error:', error);
            } finally {
                // Clear client-side data
                sessionStorage.removeItem('tempUserData');
                // Redirect to login
                window.location.href = 'auth.html';
            }
        }

        // Global functions
        window.showSection = showSection;
        window.logout = logout;
        window.toggleLanguage = toggleLanguage;
        window.filterJobs = filterJobs;
        window.openEditJobForm = openEditJobForm;
        window.deleteJob = deleteJob;
        window.applyForJob = applyForJob;
        window.contactPhone = contactPhone;
        window.contactEmail = contactEmail;
        window.openBlogModal = openBlogModal;
        window.closeBlogModal = closeBlogModal;

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('blogModal');
            if (event.target === modal) {
                closeBlogModal();
            }
        }
    </script>
</body>
</html>
