<script>
    const API_BASE_URL = 'https://backita.onrender.com';
    let currentUser = null;
    let currentJobs = [];
    let currentEmployees = [];
    let currentLanguage = 'en';
    let userJobs = [];
    let currentEditingJobId = null;

    // Check authentication on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkAuthentication();
    });

    async function checkAuthentication() {
        try {
            // First check sessionStorage for user data
            const storedUser = sessionStorage.getItem('currentUser');
            const storedRole = sessionStorage.getItem('userRole');
            
            if (storedUser && storedRole) {
                try {
                    currentUser = JSON.parse(storedUser);
                    currentUser.role = storedRole;
                    initializeApp();
                    return;
                } catch (error) {
                    console.error('Error parsing stored user data:', error);
                    sessionStorage.removeItem('currentUser');
                    sessionStorage.removeItem('userRole');
                }
            }
            
            // If no stored data, try backend check
            const response = await fetch(`${API_BASE_URL}/auth/check`, {
                method: 'GET',
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.user) {
                    currentUser = data.user;
                    // Store in sessionStorage for future use
                    sessionStorage.setItem('currentUser', JSON.stringify(data.user));
                    if (data.user.role) {
                        sessionStorage.setItem('userRole', data.user.role);
                    }
                    initializeApp();
                } else {
                    redirectToAuth();
                }
            } else {
                redirectToAuth();
            }
        } catch (error) {
            console.error('Authentication check failed:', error);
            redirectToAuth();
        }
    }

    // Redirect to appropriate page based on role
    function redirectToDashboard() {
        const userRole = localStorage.getItem('userRole') || sessionStorage.getItem('userRole');
        
        if (userRole === 'employer') {
            window.location.href = 'employer-dashboard.html'; // Change to your employer page
        } else if (userRole === 'employee') {
            window.location.href = 'employee-dashboard.html'; // Change to your employee page
        } else {
            // Fallback to current page if role not found
            initializeApp();
        }
    }

    function redirectToAuth() {
        window.location.href = 'auth.html';
    }

    function initializeApp() {
        // Get user role from localStorage or sessionStorage
        const userRole = localStorage.getItem('userRole') || sessionStorage.getItem('userRole');
        
        // If we have a role but it doesn't match current page, redirect
        if (userRole && shouldRedirectBasedOnRole(userRole)) {
            redirectToDashboard();
            return;
        }

        // Update UI with user info
        document.getElementById('userName').textContent = currentUser.name;
        
        // Update role badge
        const roleBadge = document.getElementById('userRoleBadge');
        if (currentUser.role === 'employer') {
            roleBadge.textContent = currentLanguage === 'en' ? 'Employer' : 'Mwajiri';
            roleBadge.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)';
        } else {
            roleBadge.textContent = currentLanguage === 'en' ? 'Employee' : 'Mfanyakazi';
            roleBadge.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        }
        
        // Update welcome message
        document.getElementById('welcomeMessage').textContent = currentLanguage === 'en' 
            ? `Welcome ${currentUser.name}!` 
            : `Karibu ${currentUser.name}!`;
        
        // Show role-specific content
        updateRoleBasedUI();
        
        // Set language from user preference or default to English
        const savedLanguage = localStorage.getItem('preferredLanguage');
        if (savedLanguage) {
            currentLanguage = savedLanguage;
        }
        updateLanguageDisplay();
        translatePage();
        
        // Load initial data
        loadBlogs();
        loadJobs();
        loadEmployees();
        
        // Setup event listeners
        document.getElementById('jobForm').addEventListener('submit', handleJobPost);
    }

    // Check if user should be redirected based on their role and current page
    function shouldRedirectBasedOnRole(userRole) {
        const currentPage = window.location.pathname.split('/').pop();
        
        // Define which pages are for which roles
        const employerPages = ['employer-dashboard.html', 'employer.html']; // Add your employer page names
        const employeePages = ['employee-dashboard.html', 'employee.html']; // Add your employee page names
        
        if (userRole === 'employer' && !employerPages.includes(currentPage)) {
            return true;
        }
        
        if (userRole === 'employee' && !employeePages.includes(currentPage)) {
            return true;
        }
        
        return false;
    }

    // Update UI based on user role
    function updateRoleBasedUI() {
        const isEmployer = currentUser.role === 'employer';
        const isEmployee = currentUser.role === 'employee';
        
        // Show/hide navigation items
        document.getElementById('postJobNav').classList.toggle('hidden', !isEmployer);
        document.getElementById('employeesNav').classList.toggle('hidden', !isEmployer);
        document.getElementById('myApplicationsNav').classList.toggle('hidden', !isEmployee);
        
        // Show/hide welcome sections
        document.getElementById('employerWelcome').classList.toggle('hidden', !isEmployer);
        document.getElementById('employeeWelcome').classList.toggle('hidden', !isEmployee);
        
        // Update welcome section styling
        const welcomeSection = document.getElementById('welcomeSection');
        if (isEmployer) {
            welcomeSection.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)';
        } else {
            welcomeSection.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        }
    }

    // Language functions
    function toggleLanguage() {
        currentLanguage = currentLanguage === 'en' ? 'sw' : 'en';
        localStorage.setItem('preferredLanguage', currentLanguage);
        updateLanguageDisplay();
        translatePage();
        
        // Update welcome message
        document.getElementById('welcomeMessage').textContent = currentLanguage === 'en' 
            ? `Welcome ${currentUser.name}!` 
            : `Karibu ${currentUser.name}!`;
            
        // Update role badge
        const roleBadge = document.getElementById('userRoleBadge');
        if (currentUser.role === 'employer') {
            roleBadge.textContent = currentLanguage === 'en' ? 'Employer' : 'Mwajiri';
        } else {
            roleBadge.textContent = currentLanguage === 'en' ? 'Employee' : 'Mfanyakazi';
        }
        
        // Reload content with new language
        loadBlogs();
        loadJobs();
    }

    function updateLanguageDisplay() {
        const flagElement = document.getElementById('currentFlag');
        const languageElement = document.getElementById('currentLanguage');
        
        if (currentLanguage === 'en') {
            flagElement.textContent = 'ðŸ‡ºðŸ‡¸';
            languageElement.textContent = 'English';
        } else {
            flagElement.textContent = 'ðŸ‡°ðŸ‡ª';
            languageElement.textContent = 'Kiswahili';
        }
    }

    function translatePage() {
        // Translate text content
        const elements = document.querySelectorAll('[data-en][data-sw]');
        elements.forEach(element => {
            if (currentLanguage === 'en') {
                element.textContent = element.getAttribute('data-en');
            } else {
                element.textContent = element.getAttribute('data-sw');
            }
        });

        // Translate placeholders
        const placeholderElements = document.querySelectorAll('[data-en-placeholder][data-sw-placeholder]');
        placeholderElements.forEach(element => {
            if (currentLanguage === 'en') {
                element.placeholder = element.getAttribute('data-en-placeholder');
            } else {
                element.placeholder = element.getAttribute('data-sw-placeholder');
            }
        });

        // Translate select options
        const selectElements = document.querySelectorAll('select option');
        selectElements.forEach(option => {
            if (option.hasAttribute('data-en') && option.hasAttribute('data-sw')) {
                if (currentLanguage === 'en') {
                    option.textContent = option.getAttribute('data-en');
                } else {
                    option.textContent = option.getAttribute('data-sw');
                }
            }
        });
    }

    // Blog functions
    async function loadBlogs() {
        try {
            // Sample blog data with full articles
            const blogData = [
                {
                    id: 1,
                    title: currentLanguage === 'en' ? 'Agriculture Opportunities Growing in Rural Areas' : 'Fursa za Kilimo Zinakua Vijijini',
                    description: currentLanguage === 'en' 
                        ? 'Discover the latest farming and agricultural job opportunities across rural Kenya.' 
                        : 'Gundua fursa mpya za kazi za kilimo na ufugaji kote Kenya vijijini.',
                    image: 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)',
                    readMoreText: currentLanguage === 'en' ? 'Read More â†’' : 'Soma Zaidi â†’'
                },
                {
                    id: 2,
                    title: currentLanguage === 'en' ? 'Construction Boom Creates New Jobs' : 'Ujenzi Unazua Ajira Mpya',
                    description: currentLanguage === 'en' 
                        ? 'With infrastructure development accelerating, construction jobs are plentiful.' 
                        : 'Kwa kuongezeka kwa maendeleo ya miundombinu, kazi za ujenzi zimejaa.',
                    image: 'linear-gradient(135deg, #ed8936 0%, #dd6b20 100%)',
                    readMoreText: currentLanguage === 'en' ? 'Read More â†’' : 'Soma Zaidi â†’'
                },
                {
                    id: 3,
                    title: currentLanguage === 'en' ? 'Domestic Work Opportunities' : 'Fursa za Kazi ya Nyumbani',
                    description: currentLanguage === 'en' 
                        ? 'Reliable domestic helpers are in high demand. Learn about requirements and benefits.' 
                        : 'Wasaidizi wa nyumbani wa kuaminika wana hitaji kubwa. Jifunze kuhusu mahitaji na faida.',
                    image: 'linear-gradient(135deg, #9f7aea 0%, #805ad5 100%)',
                    readMoreText: currentLanguage === 'en' ? 'Read More â†’' : 'Soma Zaidi â†’'
                }
            ];

            const container = document.getElementById('blogContent');
            container.innerHTML = blogData.map(blog => `
                <div class="blog-card">
                    <div class="blog-image" style="background: ${blog.image};"></div>
                    <div class="blog-content">
                        <div class="blog-title">${blog.title}</div>
                        <div class="blog-description">${blog.description}</div>
                        <a href="#" class="blog-read-more" onclick="openBlogModal(${blog.id})">
                            ${blog.readMoreText}
                        </a>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading blogs:', error);
        }
    }

    function openBlogModal(blogId) {
        // Sample blog content
        const blogContent = {
            1: {
                title: currentLanguage === 'en' ? 'Agriculture Opportunities' : 'Fursa za Kilimo',
                content: currentLanguage === 'en' 
                    ? '<p>Agriculture is the backbone of rural economies...</p>'
                    : '<p>Kilimo ni msingi wa uchumi vijijini...</p>'
            },
            2: {
                title: currentLanguage === 'en' ? 'Construction Boom' : 'Ujenzi Unakua',
                content: currentLanguage === 'en' 
                    ? '<p>Construction industry is growing rapidly...</p>'
                    : '<p>Sekta ya ujenzi inakua kwa kasi...</p>'
            },
            3: {
                title: currentLanguage === 'en' ? 'Domestic Work' : 'Kazi ya Nyumbani',
                content: currentLanguage === 'en' 
                    ? '<p>Domestic work provides stable employment...</p>'
                    : '<p>Kazi ya nyumbani inatoa ajira thabiti...</p>'
            }
        };
        
        const blog = blogContent[blogId];
        if (blog) {
            document.getElementById('modalBlogTitle').textContent = blog.title;
            document.getElementById('modalBlogBody').innerHTML = `
                <div class="blog-full-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                <div class="blog-full-content">
                    ${blog.content}
                </div>
            `;
            document.getElementById('blogModal').style.display = 'block';
        }
    }

    function closeBlogModal() {
        document.getElementById('blogModal').style.display = 'none';
    }

    // Job functions
    async function loadJobs() {
        try {
            const response = await fetch(`${API_BASE_URL}/jobs`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    currentJobs = data.jobs;
                    displayJobs();
                    
                    // Load user-specific data based on role
                    if (currentUser.role === 'employer') {
                        loadUserJobs();
                    } else {
                        loadUserApplications();
                    }
                } else {
                    throw new Error('Failed to load jobs');
                }
            } else {
                // If no jobs endpoint, use sample data
                currentJobs = [
                    {
                        _id: '1',
                        title: 'Farm Worker Needed',
                        description: 'Looking for experienced farm workers for seasonal harvest.',
                        location: 'Nakuru',
                        category: 'agriculture',
                        phone: '+254712345678',
                        businessType: 'Green Valley Farms',
                        employerId: 'employer123',
                        postedDate: new Date()
                    },
                    {
                        _id: '2',
                        title: 'Construction Helper',
                        description: 'Immediate opening for construction helpers at a new residential site.',
                        location: 'Nairobi',
                        category: 'construction',
                        phone: '+254723456789',
                        businessType: 'BuildRight Construction',
                        employerId: 'employer456',
                        postedDate: new Date()
                    }
                ];
                displayJobs();
                if (currentUser.role === 'employer') {
                    loadUserJobs();
                }
            }
        } catch (error) {
            console.error('Error loading jobs:', error);
            // Use sample data as fallback
            currentJobs = [
                {
                    _id: '1',
                    title: 'Farm Worker Needed',
                    description: 'Looking for experienced farm workers for seasonal harvest.',
                    location: 'Nakuru',
                    category: 'agriculture',
                    phone: '+254712345678',
                    businessType: 'Green Valley Farms',
                    employerId: currentUser._id,
                    postedDate: new Date()
                }
            ];
            displayJobs();
        }
    }

    async function loadEmployees() {
        try {
            const response = await fetch(`${API_BASE_URL}/employees`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    currentEmployees = data.employees;
                    displayEmployees();
                }
            } else {
                // Sample employee data
                currentEmployees = [
                    {
                        _id: 'emp1',
                        name: 'John Kamau',
                        role: 'employee',
                        specialization: 'Farm Worker',
                        location: 'Nakuru',
                        phone: '+254745678901'
                    },
                    {
                        _id: 'emp2',
                        name: 'Mary Wanjiku',
                        role: 'employee',
                        specialization: 'Domestic Helper',
                        location: 'Nairobi',
                        phone: '+254756789012'
                    }
                ];
                displayEmployees();
            }
        } catch (error) {
            console.error('Error loading employees:', error);
        }
    }

    function loadUserJobs() {
        // Filter jobs posted by the current user
        userJobs = currentJobs.filter(job => job.employerId === currentUser._id);
        displayUserJobs();
    }

    async function loadUserApplications() {
        try {
            // For employees, load their job applications
            const response = await fetch(`${API_BASE_URL}/applications/user`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    displayUserApplications(data.applications);
                }
            } else {
                // Sample applications data
                const sampleApplications = currentJobs.slice(0, 2).map(job => ({
                    _id: `app${job._id}`,
                    jobId: job,
                    applicantId: currentUser._id,
                    appliedDate: new Date(),
                    status: 'pending'
                }));
                displayUserApplications(sampleApplications);
            }
        } catch (error) {
            console.error('Error loading user applications:', error);
        }
    }

    function displayUserJobs() {
        const container = document.getElementById('employerJobListings');
        const section = document.getElementById('employerJobsSection');
        
        if (userJobs.length === 0) {
            container.innerHTML = `
                <div class="message">
                    <i class="fas fa-info-circle"></i> 
                    <span data-en="You haven't posted any jobs yet." data-sw="Hujatangaza kazi yoyote bado.">
                        Hujatangaza kazi yoyote bado.
                    </span>
                </div>
            `;
        } else {
            container.innerHTML = userJobs.map(job => `
                <div class="job-card">
                    <div class="job-actions">
                        <button class="btn-action btn-edit" onclick="openEditJobForm('${job._id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteJob('${job._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="job-header">
                        <div class="job-title">${job.title}</div>
                        <div class="job-category">${job.category}</div>
                    </div>
                    <div class="job-description">${job.description}</div>
                    <div class="job-meta">
                        <div class="meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${job.location}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-building"></i>
                            <span>${job.businessType || 'Individual'}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>${new Date(job.postedDate).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="communication">
                        <span class="meta-item">
                            <i class="fas fa-phone"></i>
                            <span>${job.phone}</span>
                        </span>
                    </div>
                </div>
            `).join('');
        }
        
        section.style.display = 'block';
    }

    function displayUserApplications(applications) {
        const container = document.getElementById('employeeApplications');
        const section = document.getElementById('employeeApplicationsSection');
        
        if (!applications || applications.length === 0) {
            container.innerHTML = `
                <div class="message">
                    <i class="fas fa-info-circle"></i> 
                    <span data-en="You haven't applied to any jobs yet." data-sw="Hujaomba kazi yoyote bado.">
                        Hujaomba kazi yoyote bado.
                    </span>
                </div>
            `;
        } else {
            container.innerHTML = applications.map(app => `
                <div class="job-card">
                    <div class="job-header">
                        <div class="job-title">${app.jobId.title}</div>
                        <div class="job-category">${app.jobId.category}</div>
                    </div>
                    <div class="job-description">${app.jobId.description}</div>
                    <div class="job-meta">
                        <div class="meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${app.jobId.location}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-building"></i>
                            <span>${app.jobId.businessType || 'Individual'}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>${currentLanguage === 'en' ? 'Applied:' : 'Iliomba:'} ${new Date(app.appliedDate).toLocaleDateString()}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-info-circle"></i>
                            <span>${currentLanguage === 'en' ? 'Status:' : 'Hali:'} ${app.status}</span>
                        </div>
                    </div>
                    <div class="communication">
                        <a href="tel:${app.jobId.phone}" class="btn btn-call">
                            <i class="fas fa-phone"></i> <span data-en="Call Employer" data-sw="Piga Mwajiri">Piga Mwajiri</span>
                        </a>
                        <a href="https://wa.me/${app.jobId.phone}?text=Hi, I applied for the ${app.jobId.title} position" 
                           class="btn btn-whatsapp" target="_blank">
                            <i class="fab fa-whatsapp"></i> <span data-en="WhatsApp" data-sw="WhatsApp">WhatsApp</span>
                        </a>
                    </div>
                </div>
            `).join('');
        }
        
        section.style.display = 'block';
    }

    function displayJobs() {
        const container = document.getElementById('jobListings');
        
        if (currentJobs.length === 0) {
            container.innerHTML = `
                <div class="message">
                    <i class="fas fa-info-circle"></i> 
                    <span data-en="No jobs available at the moment. Check back later!" data-sw="Hakuna kazi zinazopatikana kwa sasa. Angalia tena baadaye!">
                        Hakuna kazi zinazopatikana kwa sasa. Angalia tena baadaye!
                    </span>
                </div>
            `;
            return;
        }
        
        container.innerHTML = currentJobs.map(job => {
            const isEmployer = currentUser.role === 'employer';
            const applyButton = isEmployer ? '' : `
                <button class="btn btn-primary" onclick="applyForJob('${job._id}')">
                    <i class="fas fa-paper-plane"></i> <span data-en="Apply" data-sw="Omba">Omba</span>
                </button>
            `;
            
            return `
                <div class="job-card">
                    <div class="job-header">
                        <div class="job-title">${job.title}</div>
                        <div class="job-category">${job.category}</div>
                    </div>
                    <div class="job-description">${job.description}</div>
                    <div class="job-meta">
                        <div class="meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${job.location}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-building"></i>
                            <span>${job.businessType || 'Individual'}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>${new Date(job.postedDate).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="communication">
                        <a href="tel:${job.phone}" class="btn btn-call">
                            <i class="fas fa-phone"></i> <span data-en="Call" data-sw="Piga Simu">Piga Simu</span>
                        </a>
                        <a href="https://wa.me/${job.phone}?text=Hi, I am interested in the ${job.title} position" 
                           class="btn btn-whatsapp" target="_blank">
                            <i class="fab fa-whatsapp"></i> <span data-en="WhatsApp" data-sw="WhatsApp">WhatsApp</span>
                        </a>
                        ${applyButton}
                    </div>
                </div>
            `;
        }).join('');
    }

    function displayEmployees() {
        const container = document.getElementById('employeeListings');
        
        if (!currentEmployees || currentEmployees.length === 0) {
            container.innerHTML = `
                <div class="message">
                    <i class="fas fa-info-circle"></i> 
                    <span data-en="No workers available at the moment." data-sw="Hakuna wafanyikazi walioopo kwa sasa.">
                        Hakuna wafanyikazi walioopo kwa sasa.
                    </span>
                </div>
            `;
            return;
        }
        
        container.innerHTML = currentEmployees.map(employee => `
            <div class="job-card">
                <div class="job-header">
                    <div class="job-title">${employee.name}</div>
                    <div class="job-category">${employee.role}</div>
                </div>
                <div class="job-description">
                    <strong data-en="Specialization:" data-sw="Utaalamu:">Utaalamu:</strong> ${employee.specialization || (currentLanguage === 'en' ? 'General worker' : 'Mfanyakazi wa jumla')}
                </div>
                <div class="job-meta">
                    <div class="meta-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${employee.location}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-phone"></i>
                        <span>${employee.phone}</span>
                    </div>
                </div>
                <div class="communication">
                    <a href="tel:${employee.phone}" class="btn btn-call">
                        <i class="fas fa-phone"></i> <span data-en="Call" data-sw="Piga Simu">Piga Simu</span>
                    </a>
                    <a href="https://wa.me/${employee.phone}?text=Hi, I have a job opportunity for you" 
                       class="btn btn-whatsapp" target="_blank">
                        <i class="fab fa-whatsapp"></i> <span data-en="WhatsApp" data-sw="WhatsApp">WhatsApp</span>
                    </a>
                </div>
            </div>
        `).join('');
    }

    // Job application function for employees
    async function applyForJob(jobId) {
        try {
            const response = await fetch(`${API_BASE_URL}/applications/apply`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    jobId: jobId,
                    applicantId: currentUser._id
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    alert(currentLanguage === 'en' 
                        ? 'Application submitted successfully!' 
                        : 'Ombi lako limewasilishwa kikamilifu!');
                    loadUserApplications();
                } else {
                    throw new Error(data.error || 'Application failed');
                }
            } else {
                // Simulate success for demo
                alert(currentLanguage === 'en' 
                    ? 'Application submitted successfully!' 
                    : 'Ombi lako limewasilishwa kikamilifu!');
                loadUserApplications();
            }
        } catch (error) {
            console.error('Error applying for job:', error);
            alert(currentLanguage === 'en' 
                ? 'Failed to apply for job. Please try again.' 
                : 'Imeshindwa kuomba kazi. Tafadhali jaribu tena.');
        }
    }

    // Filter jobs function
    function filterJobs(e) {
        e.preventDefault();
        const positionQuery = document.getElementById('positionSearch').value.toLowerCase();
        const locationQuery = document.getElementById('locationSearch').value.toLowerCase();
        
        const filteredJobs = currentJobs.filter(job => {
            const matchesPosition = job.title.toLowerCase().includes(positionQuery);
            const matchesLocation = job.location.toLowerCase().includes(locationQuery);
            
            if (positionQuery && locationQuery) {
                return matchesPosition && matchesLocation;
            } else if (positionQuery) {
                return matchesPosition;
            } else if (locationQuery) {
                return matchesLocation;
            }
            return true;
        });
        
        const container = document.getElementById('jobListings');
        
        if (filteredJobs.length === 0) {
            container.innerHTML = `
                <div class="message">
                    <i class="fas fa-info-circle"></i> 
                    <span data-en="No jobs match your search criteria." data-sw="Hakuna kazi zinazolingana na vigezo vyako vya utafutaji.">
                        Hakuna kazi zinazolingana na vigezo vyako vya utafutaji.
                    </span>
                </div>
            `;
            return;
        }
        
        container.innerHTML = filteredJobs.map(job => {
            const isEmployer = currentUser.role === 'employer';
            const applyButton = isEmployer ? '' : `
                <button class="btn btn-primary" onclick="applyForJob('${job._id}')">
                    <i class="fas fa-paper-plane"></i> <span data-en="Apply" data-sw="Omba">Omba</span>
                </button>
            `;
            
            return `
                <div class="job-card">
                    <div class="job-header">
                        <div class="job-title">${job.title}</div>
                        <div class="job-category">${job.category}</div>
                    </div>
                    <div class="job-description">${job.description}</div>
                    <div class="job-meta">
                        <div class="meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${job.location}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-building"></i>
                            <span>${job.businessType || 'Individual'}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>${new Date(job.postedDate).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="communication">
                        <a href="tel:${job.phone}" class="btn btn-call">
                            <i class="fas fa-phone"></i> <span data-en="Call" data-sw="Piga Simu">Piga Simu</span>
                        </a>
                        <a href="https://wa.me/${job.phone}?text=Hi, I am interested in the ${job.title} position" 
                           class="btn btn-whatsapp" target="_blank">
                            <i class="fab fa-whatsapp"></i> <span data-en="WhatsApp" data-sw="WhatsApp">WhatsApp</span>
                        </a>
                        ${applyButton}
                    </div>
                </div>
            `;
        }).join('');
    }

    // Handle job posting
    async function handleJobPost(e) {
        e.preventDefault();
        
        if (currentUser.role !== 'employer') {
            alert(currentLanguage === 'en' ? 'Only employers can post jobs' : 'Ni waajiri pekee ndio wanaweza kutangaza kazi');
            return;
        }
        
        const jobData = {
            title: document.getElementById('jobTitle').value.trim(),
            description: document.getElementById('jobDescription').value.trim(),
            location: document.getElementById('jobLocation').value.trim(),
            category: document.getElementById('jobCategory').value,
            phone: document.getElementById('jobPhone').value.trim(),
            businessType: document.getElementById('businessType').value.trim() || currentUser.name,
            employerId: currentUser._id,
            employerName: currentUser.name
        };
        
        // Format phone number
        jobData.phone = formatPhoneToStandard(jobData.phone);
        
        try {
            const response = await fetch(`${API_BASE_URL}/jobs`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jobData)
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    alert(currentLanguage === 'en' ? 'Job posted successfully!' : 'Kazi imetangazwa kikamilifu!');
                    document.getElementById('jobForm').reset();
                    loadJobs();
                    showSection('profile');
                } else {
                    throw new Error(data.error || 'Failed to post job');
                }
            } else {
                // Simulate success for demo
                const newJob = {
                    _id: 'job' + Date.now(),
                    ...jobData,
                    postedDate: new Date()
                };
                currentJobs.push(newJob);
                userJobs.push(newJob);
                alert(currentLanguage === 'en' ? 'Job posted successfully!' : 'Kazi imetangazwa kikamilifu!');
                document.getElementById('jobForm').reset();
                displayJobs();
                displayUserJobs();
                showSection('profile');
            }
        } catch (error) {
            console.error('Error posting job:', error);
            alert(currentLanguage === 'en' 
                ? 'Failed to post job. Please try again.' 
                : 'Imeshindwa kutangaza kazi. Tafadhali jaribu tena.');
        }
    }

    function formatPhoneToStandard(phone) {
        let cleanPhone = phone.replace(/\D/g, '');
        
        // Convert to 254 format for backend
        if (cleanPhone.startsWith('0')) {
            cleanPhone = '254' + cleanPhone.substring(1);
        } else if (!cleanPhone.startsWith('254')) {
            cleanPhone = '254' + cleanPhone;
        }
        
        return cleanPhone;
    }

    function openEditJobForm(jobId) {
        const job = userJobs.find(j => j._id === jobId);
        if (!job) return;
        
        currentEditingJobId = jobId;
        
        // Fill the form with job data
        document.getElementById('jobTitle').value = job.title;
        document.getElementById('jobDescription').value = job.description;
        document.getElementById('jobLocation').value = job.location;
        document.getElementById('jobCategory').value = job.category;
        document.getElementById('jobPhone').value = job.phone;
        document.getElementById('businessType').value = job.businessType;
        
        // Change form button text
        const submitButton = document.querySelector('#jobForm button[type="submit"]');
        submitButton.innerHTML = `<i class="fas fa-save"></i> <span data-en="Update Job" data-sw="Sasisha Kazi">Sasisha Kazi</span>`;
        
        // Navigate to post job section
        showSection('post');
    }

    async function deleteJob(jobId) {
        if (confirm(currentLanguage === 'en' 
            ? 'Are you sure you want to delete this job?' 
            : 'Una uhakika unataka kufuta kazi hii?')) {
            try {
                const response = await fetch(`${API_BASE_URL}/jobs/${jobId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        alert(currentLanguage === 'en' ? 'Job deleted successfully!' : 'Kazi imefutwa kikamilifu!');
                        loadJobs();
                    } else {
                        throw new Error('Failed to delete job');
                    }
                } else {
                    // Simulate deletion for demo
                    userJobs = userJobs.filter(job => job._id !== jobId);
                    currentJobs = currentJobs.filter(job => job._id !== jobId);
                    alert(currentLanguage === 'en' ? 'Job deleted successfully!' : 'Kazi imefutwa kikamilifu!');
                    displayUserJobs();
                    displayJobs();
                }
            } catch (error) {
                console.error('Error deleting job:', error);
                alert(currentLanguage === 'en' ? 'Failed to delete job.' : 'Imeshindwa kufuta kazi.');
            }
        }
    }

    // Navigation functions
    function showSection(section) {
        // Hide all sections
        document.getElementById('homeSection').style.display = 'none';
        document.getElementById('jobsSection').style.display = 'none';
        document.getElementById('profileSection').style.display = 'none';
        document.getElementById('postJobSection').style.display = 'none';
        document.getElementById('employeesSection').style.display = 'none';
        document.getElementById('applicationsSection').style.display = 'none';
        
        // Remove active class from all nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Show selected section and set active nav
        if (section === 'home') {
            document.getElementById('homeSection').style.display = 'block';
            document.querySelectorAll('.nav-item')[0].classList.add('active');
        } else if (section === 'jobs') {
            document.getElementById('jobsSection').style.display = 'block';
            document.querySelectorAll('.nav-item')[1].classList.add('active');
        } else if (section === 'profile') {
            document.getElementById('profileSection').style.display = 'block';
            document.querySelectorAll('.nav-item')[2].classList.add('active');
            loadProfile();
        } else if (section === 'post') {
            document.getElementById('postJobSection').style.display = 'block';
            document.querySelectorAll('.nav-item')[3].classList.add('active');
            
            // Reset form if not editing
            if (!currentEditingJobId) {
                document.getElementById('jobForm').reset();
                const submitButton = document.querySelector('#jobForm button[type="submit"]');
                submitButton.innerHTML = `<i class="fas fa-plus"></i> <span data-en="Post Job" data-sw="Tangaza Kazi">Tangaza Kazi</span>`;
            }
        } else if (section === 'employees') {
            document.getElementById('employeesSection').style.display = 'block';
            document.querySelectorAll('.nav-item')[4].classList.add('active');
        } else if (section === 'applications') {
            document.getElementById('applicationsSection').style.display = 'block';
            document.querySelectorAll('.nav-item')[5].classList.add('active');
        }
    }

    function loadProfile() {
        // Update profile information
        document.getElementById('profileName').textContent = currentUser.name;
        document.getElementById('profilePhone').textContent = currentUser.phone;
        document.getElementById('profileLocation').textContent = currentUser.location;
        
        if (currentUser.role === 'employee') {
            document.getElementById('profileSpecialization').textContent = currentUser.specialization || 'Not specified';
            document.getElementById('specializationGroup').style.display = 'block';
            document.getElementById('jobTypeGroup').style.display = 'none';
        } else {
            document.getElementById('profileJobType').textContent = currentUser.jobType || 'Not specified';
            document.getElementById('specializationGroup').style.display = 'none';
            document.getElementById('jobTypeGroup').style.display = 'block';
        }
    }

    function logout() {
        // Clear all stored data
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        localStorage.removeItem('userRole');
        sessionStorage.removeItem('currentUser');
        sessionStorage.removeItem('userRole');
        
        // Redirect to auth page
        window.location.href = 'auth.html';
    }

    // Global functions
    window.showSection = showSection;
    window.toggleLanguage = toggleLanguage;
    window.openBlogModal = openBlogModal;
    window.closeBlogModal = closeBlogModal;
    window.applyForJob = applyForJob;
    window.filterJobs = filterJobs;
    window.openEditJobForm = openEditJobForm;
    window.deleteJob = deleteJob;
    window.logout = logout;
</script>
